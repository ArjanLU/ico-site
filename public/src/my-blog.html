<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="ico-blog">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      .follow-header{
        background:var(--accent-color);
      }

    ol {
   list-style: none;
 }
  li {
   counter-increment: item;
   margin-bottom: 5px;
 }

li:before {
   margin-right: 10px;
   content: counter(item);
   color: var(--app-secondary-color);
   width: 1.2em;
   font-size:24px;
 }
    </style>

<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subRoute}}" active="{{routeActive}}"></app-route>
  <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="blog" role="main" scroll-target="document">
      <div class="training-page" name="blogitem">
        
          <template is="dom-if" if="[[blogitem]]">
            <div id="case-header"></div>
            <div class="case-content">
              <div class="case-intro">
                <h1>[[blogitem.title]]</h1>
                <p>[[blogitem.subtitle]]</p>
                <div class="subtitle" style="font-style:italic;font-size:0.8em">Gepubliceerd op [[_formatDate(blogitem.created)]] door [[blogitem.author]]</div>
                <div class="link"> 
                  <a name="cases" on-click="_back">
                    <iron-icon icon="my-icons:arrow-back"></iron-icon>
                    Terug 
                  </a>
                </div>
              </div>
          </div>

          <div class="follow-content">
            <div class="home-text">
              <div class="text-field fullwidth">
                <div class="subtitle"></div>
                <div class="title"><h1>Inleiding</h1></div>
                <p>[[blogitem.shortdescription]]</p>
                <div style="display:contents" inner-H-T-M-L="[[_formatContent(blogitem.content)]]"></div>
                <div class="feedbackbar" style=" display: flex; justify-content: flex-start; padding-right: 25px;padding-top:50px">
                  <template is="dom-repeat" items="[[blogitem.tags]]">
                    <div class="blogtag">[[item]]</div>
                  </template>
                  <div style="flex:1"></div>
                  <img src="./images/clap.png" style="padding: 0px 25px;" height="24" on-click="_clap"/><span>[[blogitem.claps]]</span>
                </div>
              </div>
            </div>
          </div>


            <div class="follow-content">
                <div style="width:100%;" class="text-field fullwidth">
                  <div class="subtitle">Praat mee</div>
                  <div class="title"><h1>Laat hier jouw mening achter</h1></div>
                  <template is="dom-repeat" items="[[_reverse(blogcomments)]]">
                     <p style="white-space: pre;text-align:left;font-style:italic;font-size:0.9em;margin:25px 0px 0px 0px;">[[item.content]]</p>
                     <div class="subtitle" style="font-style:italic;font-size:0.8em">
                      Commentaar van [[item.author]] op [[_formatDate(item.created)]]
                    </div>
                  </template>
              </div>
                <div style="width:100%;max-width:400px;margin:5px;display: flex;flex-wrap: wrap;justify-content: flex-end;">
                     <textarea maxlength="150" style="width:100%" cols="40" rows="5" id="comment" value="{{content::input}}"></textarea><br/>
                     <input style="width:100%;border:1px solid grey;height:20px" type="text" id="author" name="author" placeholder="naam" value="{{naam::keydown}}"></input>
                     <paper-button disabled$="[[disabled]]" raised icon="menu" on-tap="_saveComment">Verstuur</paper-button>
                </div>
            </div>

              <div class="inverse-link"  style="justify-content: flex-start;margin:25px;"> 
                <a name="cases" on-click="_back">
                  <iron-icon icon="my-icons:arrow-back"></iron-icon>
                 Terug 
                </a>
              </div>     
        </template>
      </div>
    
      <div name="blog">
          <div class="follow-header">
              <div class="follow-header-text">
                <div>
                  Professionals van Iconica praten over techniek
                </div>
              </div>
          </div>
        <template is="dom-repeat" items="[[blogarticles]]">
        <div class="follow-content">
          <div class="home-text">
            <div class="text-field">
              <div class="subtitle">[[item.subtitle]]</div>
              <div class="title"><h1>[[item.title]]</h1>
              </div>
              <p>[[item.shortdescription]]</p>
              <div class="subtitle" style="font-style:italic;font-size:0.8em">Gepubliceerd op [[_formatDate(item.created)]] door [[item.author]]</div>
              <div class="inverse-link"> <a name="more" on-click="_selectBlog">Lees meer...</a>
                <iron-icon icon="my-icons:arrow-forward"></iron-icon>
              </div>
            </div>
          </div>
        </template>
      </div>
  </iron-pages>
</template>

<script>
  class MyBlog extends Polymer.Element {
    static get is() { return 'ico-blog'; }
    static get observers() {
      return ['_routeChanged(route.*, blogarticles.*)', '_buttonStatus(naam, content)']
    }
    static get properties () {
      return {
        blogitem:{ type:Object, value:{} },
        blogarticles:{ type:Array, value:[] },
        blogcomments:{ type:Array, value:[]},
        disabled: { type:Boolean, value:false},
        naam: { type:String, value:''},
        content: { type:String, value:''},
      }
    }

_reverse(arr){
  return arr.filter(b => b.id == this.blogitem.id).reverse();
}
    _buttonStatus(naam, content){
      this.disabled =  (this.naam === "" || this.content === "");
    }

    _routeChanged(route){
      if (this.routeData.page != undefined && this.routeData.page != "") {
        this.set('blogitem',this.blogarticles.find(a => a.title.includes(this.routeData.page)));
      }
      this.set("page", this.routeActive && this.routeData.page ? "blogitem" :"blog");

    }

    _formatContent(content){
      var con = "";
      if (content != undefined)
        con = content.replace(/\[\*/g, '<').replace(/\*\]/g, '>');
      return con;
    }

    _formatDate(date){
      return new Intl.DateTimeFormat('nl-NL', {}).format(date)
    }

    _back(){   
      this.set('route.path', "");
    }

    _selectBlog(e){
      console.log("blogitem selected");
      this.set('route.path', "/" + e.model.item.title);
      this.dispatchEvent(new CustomEvent('blogitem-selected', { detail:{ blogitem:e.model.item}, composed:true, bubbles:true}));
      this.set('blogcomments', this.blogcomments.slice());
    }

    _clap(){
      if (!this.blogitem.claps)
        this.blogitem.claps = 0;
      this.set('blogitem.claps', this.blogitem.claps + 1);
      this.dispatchEvent(new CustomEvent('clap', { detail:{ blogitem:this.blogitem}, composed:true, bubbles:true}));
    }
    _saveComment(){
      let content = this.shadowRoot.querySelector("#comment").value;
      let author = this.shadowRoot.querySelector("#author").value;
      let id = this.blogitem.id;
      let comment = { content : content.trim(), author : author.trim(), id };
      this.dispatchEvent(new CustomEvent('comment', { detail:{ comment:comment}, composed:true, bubbles:true}));
      this.naam = "";
      this.content = "";

    }

  }


  window.customElements.define(MyBlog.is, MyBlog);
</script>
</dom-module>